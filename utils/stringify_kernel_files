#! /usr/bin/env python
#------------------------------------------------------------------------------#
# Copyright (c) 2012 Los Alamos National Security, LLC
# All rights reserved.
#------------------------------------------------------------------------------#

import subprocess
import re
import os.path
import sys

#------------------------------------------------------------------------------#
# usage
#------------------------------------------------------------------------------#

if len(sys.argv) != 3:
	print 'Usage: ' + sys.argv[0] + ' <search directory> <output file>'
	sys.exit(1)

#------------------------------------------------------------------------------#
# find kernel files (.cl)
#------------------------------------------------------------------------------#

sp0 = subprocess.Popen(["find " + sys.argv[1] + " -regex '.*\.cl'"],
	stdout=subprocess.PIPE, shell=True)

output = open(sys.argv[2], 'w')

output.write('/*\n')
output.write(
	' * THIS FILE WAS GENERATED BY utils/stringify_kernel_files DO NOT EDIT\n')
output.write(' */\n\n')

output_define = re.sub('^.*\/', '', re.sub('\.', '_', sys.argv[2]))
output.write('#ifndef ' + output_define + '\n')
output.write('#define ' + output_define + '\n\n')

#------------------------------------------------------------------------------#
# process files
#------------------------------------------------------------------------------#

for inputname in sp0.stdout.readlines():

	#---------------------------------------------------------------------------#
	# strip comments from file
	#---------------------------------------------------------------------------#

	sp1 = subprocess.Popen(["cpp -fpreprocessed -dD -E " +
		inputname.rstrip() + " | sed 's,# .*,,g'"],
		stdout=subprocess.PIPE, shell=True)		

	#---------------------------------------------------------------------------#
	# create string name and begin output
	#---------------------------------------------------------------------------#

	charname = re.sub('^.*\/', '', re.sub('\.cl', '', inputname.rstrip()))

	output.write('const char * ' + charname + '_PPSTR = \n')

	for line in sp1.stdout.readlines():
		if len(line.rstrip()) == 0:
			continue

		line = re.sub('\"', '\\"', re.sub('\\\\', '\\\\\\\\', line.rstrip()))
		output.write('\"' + line + ' \\n\"\n')

	output.write(';\n\n')

#------------------------------------------------------------------------------#
# close up shop
#------------------------------------------------------------------------------#

output.write('#endif // ' + output_define + '\n')
output.close()
